[Go to wiki main page](wiki_index.md)
***

# Common description

* The project is based on such technologies as: Node.JS, Express, Docker, Docker-compose, [Prisma](https://www.prisma.io/), GraphQL, [Agenda](https://github.com/agenda/agenda), PostgreSQL, MongoDB, JWT, [Argon2](https://github.com/ranisalt/node-argon2), Mocha, Swagger.
* The project uses `graphql-yoga` as the main GraphQL server.
* The main database is PostgreSQL.
* The project uses [node cluster](https://nodejs.org/api/cluster.html)
* Web server using [compression](https://github.com/expressjs/compression)
* The main ORM for working with a database is Prisma, running in a Docker container and associated with a PostgreSQL Docker container.
* To work with Prisma server - use an automatically generated CRUD, generated by library `prisma-client-lib`.
* HTTP server is the Express server included in the `graphql-yoga` library.
* All scripts needed to run and manage the project are in `package.json` in the `scripts` section and can be launched via `yarn [script_name]` or `npm run [script_name]` commands.
* Direct access to the database can be obtained using the `pg` library.
* The application has a user management system (registration/login/password changing) using JWT. Passwords are hashed using the `argon2` algorithm.
* GraphQL API documentation has been created and is available using the GraphQL server; you can see it in the Playground, accessible via the path specified in file `config.js`.
* REST API documentation was created using the Swagger documentation file `swagger.yml`, and generated using the `redoc-cli` library. The documentation is located in the `docs` folder.
* Database structure is described using the GraphQL schema in the `datamodel.graphql` file. When you run the `[dev/prod]-prisma-deploy` command, the database schema is deployed in PostgreSQL.
* Queries and Mutations, described in the file `seed.graphql`, are executed after the database is deployed, and are the initial data added to the database as, for example, data for tests.
* All application settings are stored in the `config.js` file, the folder with this file is mounted to the host system from the Docker container.
* To protect the server from DDoS attacks, the `express-rate-limit` library is used, and to limit the size of the requested data in the GraphQL API,` graphql-cost-analysis`.
* To separate access rights to the GraphQL API, the `graphql-shield` library is used.
* Redis is used to cache requests on server side. Also GraphQL server's option `cacheControl` is used to help control cache in client side.
* The project uses the logging architecture:
  * **Trace** - output everything in a row.
  * **Debug** - logging of the moments of calling "large" operations. Start / stop flow, user request, etc.
  * **Info** - one-time operations that are repeated very rarely, but not regularly. (loading config, plugin, running backup)
  * **Warning** - unexpected call parameters, strange request format, use of default values ​​as substitutes for incorrect ones. In general, everything that may indicate non-regular use.
  * **Error** - a reason for the attention of developers.
  * **Fatal** - we can display everything we can reach, as the application will not work further.
* For planning and performing tasks, the library `agenda` is used, which stores tasks in MongoDB, and the `agendash` library is used as a web interface to the task manager along the path configured in `config.js`. To access Agendash, you must specify the user token with the role `ADMIN`, in headers in HTTP request.
* Application has implemented "Maintenance mode", which can be enabled or disabled in `config.js`. When this mode is enabled, the server stops responding to all HTTP requests, except for requests from IP addresses allowed in the `config.js` file.
* Application server is described in the `server.js` file. All business logic of the application is described in the file `app.js` 
* Application server is described in the `server.js` file. All business logic of the application is described in the file `app.js` 

# Project structure

 Object                                    | Type          | Description  
-------------------------------------------|---------------|--------------
 src/config/**config.js**                  | **File**      | Example of `config.js`  
 src/database/**datamodel.graphql**        | **File**      | Database structure in GraphQL schema format  
 src/database/**prisma.yml**               | **File**      | Config for Prisma  
 docs/**swagger.yml**                      | **File**      | [Swagger](https://swagger.io) config  
 docs/**redoc-static.html**                | **File**      | Auto-generated REST API documentation by [ReDoc-cli](https://github.com/Rebilly/ReDoc/blob/master/cli/README.md)  
 src/database/**seed.graphql**             | **File**      | Initial data for empty database (ex.: first user - admin, test products in catalog, etc...)   
 src/generated/**prisma-client**           | **Directory** | Auto-generated GraphQL [client](https://www.prisma.io/docs/prisma-client) for database
 src/**helper**                            | **Directory** | Any tools and helper classes
 src/**resolver**                          | **Directory** | GraphQL resolvers (modules, that implements public GraphQL API)
 src/**router**                            | **Directory** | REST API routers (modules, that implements public REST API)
 src/**core**                              | **Directory** | Modules works with database and implements business logic
 src/**template**                          | **Directory** | Template files for email and other things 
 **.env_example**                          | **File**      | Example of `.env` file, contains environments variables for Docker container 
 **.dockerignore**                         | **File**      | Docker ignore file (describes which files should not get inside Docker container)  
 **docker-compose.yml**                    | **File**      | Docker compose file for production launch  
 **docker-compose-dev.yml**                | **File**      | Docker compose file for development launch  
 **Dockerfile**                            | **File**      | [Dockerfile](https://docs.docker.com/engine/reference/builder)  
 src/schema/**schema.graphql**             | **File**      | GraphQL schema for public API  
 src/**server.js**                         | **File**      | Describes basic server launch functions
 src/**cluster.js**                        | **File**      | Describes [node cluster](https://nodejs.org/api/cluster.html)
 src/**app.js**                            | **File**      | Describes public api structure and partially business logic (ex.: data access permissions)   
 **data**                                  | **Directory** | Docker volumes storage   

# NPM scripts

 Command                | Environment     | Description
 -----------------------|-----------------|--------------
 **dev-start-app**      | Development     | Start server for dev.
 **dev-prisma-deploy**  | Development     | Deploy database structure to Prisma and generate API documentation 
 **dev-prisma-deploy-f**| Development     | Execute `dev-prisma-deploy` command but with `force` flag
 **dev-prisma-reset**   | Development     | Drop database
 **dev-prisma-seed**    | Development     | Put initial data to database (from `seed.graphql`) 
 **dev-clear**          | Development     | Delete all data (All storage folders, Docker containers)
 **dev-start**          | Development     | Start Docker development environment containers 
 **dev-stop**           | Development     | Stop Docker development environment containers
 **dev-generate-docs**  | Development     | Generate API docs
 **clear**              | Dev&**Prod**    | Delete ignored folders (databases, logs, config...)
 **sms**                | Dev&**Prod**    | Run secure memory storage CLI
 **prod-start-app**     | **Production**  | Start server (for Docker)
 **prod-build**         | **Production**  | Build Docker container of app 
 **prod-up**            | **Production**  | Update & start Docker container of app
 **prod-start**         | **Production**  | Start Docker container of app
 **prod-full-restart**  | **Production**  | Stop Docker container, rebuild/update it and start again
 **prod-clear**         | **Production**  | Delete all data (All storage folders, Docker containers)
 **prod-logs**          | **Production**  | Show logs output of app's container
 **prod-stop**          | **Production**  | Stop Docker app container of app
 **prod-init**          | **Production**  | Copy config and dotenv file from to production paths

# Dependencies description

* **agenda** - Job manager
* **agendash** - Web interface for Agenda, by default available at `/jobs_dashboard` endpoint
* **argon2** - Hashing algorithm
* **redis** - Server-side in-memory database for data cache
* **express-rate-limit** - Basic rate-limiting middleware for Express. Use to limit repeated requests to public APIs and/or endpoints such as password reset.
* **graphql-cost-analysis** - A GraphQL request cost analyzer. This can be used to protect GraphQL servers against DoS attacks, compute the data consumption per user and limit it.
* **graphql-import** - Import & export definitions in GraphQL SDL (Schema Definition Language)
* **graphql-shield** - A GraphQL tool to ease the creation of permission layer
* **graphql-yoga** - Main GraphQL server
* **prisma-client-lib** - This package includes all dependencies besides `graphql` needed in order to run Prisma client in JavaScript, TypeScript and Flow.
